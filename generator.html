<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src https: data:; frame-ancestors 'none'; base-uri 'self'; form-action 'none';">
    <meta name="referrer" content="no-referrer">
    <title>GIF CAPTCHA ‚Äî Workshop</title>
    <link rel="stylesheet" href="shared.css">
    <style>
        /* generator.html ‚Äî page-specific styles (base styles in shared.css) */

        /* Tabs */
        .tab-bar {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 2rem;
            gap: 0;
        }
        .tab-btn {
            padding: 0.8rem 1.5rem;
            background: none;
            border: none;
            color: var(--muted);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Buttons (extend shared.css) */
        .btn-danger { background: var(--red-bg); color: var(--red); border: 1px solid rgba(248,81,73,0.3); }
        .btn-danger:hover { background: rgba(248,81,73,0.25); }
        .btn-success { background: var(--green-bg); color: var(--green); border: 1px solid rgba(63,185,80,0.3); }
        .btn-success:hover { background: rgba(63,185,80,0.25); }
        .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }
        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
            color: var(--text);
        }
        .form-group .hint {
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 0.2rem;
        }
        input[type="text"], input[type="url"], textarea, select {
            width: 100%;
            padding: 0.6rem 0.8rem;
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }
        input::placeholder, textarea::placeholder { color: var(--muted); }
        textarea { resize: vertical; min-height: 60px; }
        select { cursor: pointer; }

        /* Challenge cards in editor */
        .challenge-list {
            margin-bottom: 1.5rem;
        }
        .challenge-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 0.75rem;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .challenge-card:hover { border-color: var(--accent); }
        .challenge-card.editing { border-color: var(--accent); }
        .challenge-card .card-row {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            gap: 0.75rem;
        }
        .challenge-card .card-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        .challenge-card .card-info {
            flex: 1;
            min-width: 0;
        }
        .challenge-card .card-title {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .challenge-card .card-url {
            font-size: 0.75rem;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .challenge-card .card-preview {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            background: #000;
            overflow: hidden;
            flex-shrink: 0;
        }
        .challenge-card .card-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .challenge-card .card-actions {
            display: flex;
            gap: 0.3rem;
            flex-shrink: 0;
        }
        .icon-btn {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: none;
            color: var(--muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .icon-btn:hover { color: var(--text); border-color: var(--text); }
        .icon-btn.danger:hover { color: var(--red); border-color: var(--red); }
        .icon-btn.up:hover, .icon-btn.down:hover { color: var(--accent); border-color: var(--accent); }

        /* Editor form (within card) */
        .card-editor {
            display: none;
            padding: 1rem;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }
        .challenge-card.editing .card-editor { display: block; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--muted);
        }
        .empty-state .emoji { font-size: 3rem; margin-bottom: 1rem; }
        .empty-state p { margin-bottom: 0.5rem; }

        /* Stats bar */
        .stats-bar {
            display: flex;
            gap: 1.5rem;
            padding: 1rem 1.25rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.85rem;
        }
        .stat-item .stat-value {
            font-weight: 700;
            color: var(--accent);
        }
        .stat-item .stat-label { color: var(--muted); }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.7rem 1.5rem;
            font-size: 0.85rem;
            color: var(--text);
            z-index: 1000;
            transition: transform 0.3s ease;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }
        .toast.visible {
            transform: translateX(-50%) translateY(0);
        }
        .toast.success { border-color: rgba(63,185,80,0.5); }
        .toast.error { border-color: rgba(248,81,73,0.5); }

        /* Preview mode */
        .preview-container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        .preview-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .preview-header .label {
            font-size: 0.85rem;
            color: var(--muted);
        }
        .preview-gif {
            width: 100%;
            min-height: 180px;
            max-height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        .preview-gif img {
            max-width: 100%;
            max-height: 350px;
            object-fit: contain;
        }
        .preview-gif .gif-loading { color: var(--muted); font-size: 0.9rem; }
        .preview-prompt {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
        }
        .preview-prompt .prompt-text { font-weight: 600; font-size: 0.95rem; margin-bottom: 0.3rem; }
        .preview-prompt .prompt-hint { font-size: 0.8rem; color: var(--muted); }
        .preview-input {
            padding: 1rem 1.25rem;
        }
        .preview-input textarea {
            width: 100%;
            min-height: 70px;
            padding: 0.6rem 0.8rem;
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
        }
        .preview-input textarea:focus { outline: none; border-color: var(--accent); }
        .preview-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.6rem;
        }
        .preview-reveal {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
        }
        .reveal-block {
            padding: 0.8rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        .reveal-block.expected { background: var(--green-bg); border: 1px solid rgba(63,185,80,0.3); }
        .reveal-block.user { background: var(--purple-bg); border: 1px solid rgba(188,140,255,0.3); }
        .reveal-block .reveal-lbl {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.2rem;
        }
        .reveal-block.expected .reveal-lbl { color: var(--green); }
        .reveal-block.user .reveal-lbl { color: var(--purple); }
        .reveal-block .reveal-txt { font-size: 0.85rem; font-style: italic; }

        /* Progress */
        .preview-progress {
            padding: 0.8rem 1.25rem;
            border-bottom: 1px solid var(--border);
        }
        .progress-track {
            width: 100%;
            height: 5px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 0.4rem;
            font-size: 0.75rem;
            color: var(--muted);
        }

        /* Import/Export */
        .code-block {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'SFMono-Regular', Consolas, monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--text);
            max-height: 300px;
            overflow-y: auto;
        }

        /* Category selector */
        .category-chips {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }
        .category-chip {
            padding: 0.25rem 0.7rem;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .category-chip:hover { border-color: var(--accent); color: var(--text); }
        .category-chip.selected {
            border-color: var(--accent);
            background: rgba(88, 166, 255, 0.15);
            color: var(--accent);
        }

        /* Results summary */
        .results-summary {
            text-align: center;
            padding: 2rem 1rem;
        }
        .results-summary .big-score {
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        .results-summary .big-label {
            font-size: 0.9rem;
            color: var(--muted);
            margin-bottom: 1.5rem;
        }
        .results-list {
            text-align: left;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }
        .results-row {
            display: flex;
            align-items: center;
            padding: 0.6rem 1rem;
            gap: 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }
        .results-row:last-child { border-bottom: none; }
        .results-row .r-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        .results-row .r-title { flex: 1; }
        .results-row .r-status { font-weight: 600; flex-shrink: 0; }

        /* .hidden ‚Äî see shared.css */

        @media (max-width: 600px) {
            .tab-btn { padding: 0.6rem 0.8rem; font-size: 0.85rem; }
            .stats-bar { gap: 0.8rem; }
            .challenge-card .card-preview { display: none; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõ†Ô∏è GIF CAPTCHA Workshop</h1>
        <p class="subtitle">Create, preview, and export custom GIF CAPTCHA challenge sets</p>
        <div class="nav-links">
            <a href="index.html">‚Üê Case Study</a>
            <a href="demo.html">üéÆ Demo</a>
            <a href="analysis.html">üìä Analysis</a>
            <a href="simulator.html">ü§ñ Simulator</a>
            <a href="temporal.html">‚è±Ô∏è Temporal</a>
        </div>
    </div>

    <div class="container">
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="build" onclick="switchTab('build')">‚úèÔ∏è Build</button>
            <button class="tab-btn" data-tab="preview" onclick="switchTab('preview')">‚ñ∂Ô∏è Preview</button>
            <button class="tab-btn" data-tab="export" onclick="switchTab('export')">üì¶ Export / Import</button>
        </div>

        <!-- BUILD TAB -->
        <div class="tab-pane active" id="tab-build">
            <div class="stats-bar" id="statsBar">
                <div class="stat-item">
                    <span class="stat-value" id="statCount">0</span>
                    <span class="stat-label">challenges</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statCategories">0</span>
                    <span class="stat-label">categories</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statAvgDiff">‚Äî</span>
                    <span class="stat-label">avg difficulty</span>
                </div>
                <div class="stat-item" style="margin-left: auto;">
                    <button class="btn btn-primary btn-small" onclick="openAddForm()">+ Add Challenge</button>
                    <button class="btn btn-secondary btn-small" onclick="loadSampleSet()">Load Sample Set</button>
                </div>
            </div>

            <div id="challengeList" class="challenge-list"></div>

            <div id="emptyState" class="empty-state">
                <div class="emoji">üéûÔ∏è</div>
                <p><strong>No challenges yet</strong></p>
                <p>Add GIF challenges to build your custom CAPTCHA set</p>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="openAddForm()">+ Add Your First Challenge</button>
                    <button class="btn btn-secondary" onclick="loadSampleSet()" style="margin-left: 0.5rem;">Load Sample Set</button>
                </div>
            </div>

            <!-- Add/Edit Form (modal-like overlay within page) -->
            <div id="addForm" class="hidden" style="background: var(--surface); border: 1px solid var(--accent); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem; font-size: 1rem;" id="formTitle">Add New Challenge</h3>
                <div class="form-group">
                    <label for="inputTitle">Title *</label>
                    <input type="text" id="inputTitle" placeholder="e.g., Dancing Penguin" maxlength="100">
                    <div class="hint">Short descriptive name for this GIF challenge</div>
                </div>
                <div class="form-group">
                    <label for="inputGifUrl">GIF URL *</label>
                    <input type="url" id="inputGifUrl" placeholder="https://media.giphy.com/media/.../giphy.gif">
                    <div class="hint">Direct link to an animated GIF (must be HTTPS)</div>
                </div>
                <div class="form-group">
                    <label for="inputSourceUrl">Source URL</label>
                    <input type="url" id="inputSourceUrl" placeholder="https://tenor.com/view/...">
                    <div class="hint">Original source page (optional, for attribution)</div>
                </div>
                <div class="form-group">
                    <label for="inputExpected">Expected Answer *</label>
                    <textarea id="inputExpected" placeholder="Describe the unexpected event that a human would notice" maxlength="500"></textarea>
                    <div class="hint">The correct human description of the unexpected event in this GIF</div>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <div class="category-chips" id="categoryChips">
                        <button class="category-chip" data-cat="narrative" onclick="selectCategory(this)">Narrative Twist</button>
                        <button class="category-chip" data-cat="physical" onclick="selectCategory(this)">Physical Comedy</button>
                        <button class="category-chip" data-cat="animal" onclick="selectCategory(this)">Animal Behavior</button>
                        <button class="category-chip" data-cat="visual" onclick="selectCategory(this)">Visual Trick</button>
                        <button class="category-chip" data-cat="social" onclick="selectCategory(this)">Social Subversion</button>
                        <button class="category-chip" data-cat="illusion" onclick="selectCategory(this)">Optical Illusion</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputDifficulty">AI Difficulty (1‚Äì10)</label>
                    <div style="display: flex; align-items: center; gap: 0.8rem;">
                        <input type="range" id="inputDifficulty" min="1" max="10" value="5" style="flex: 1; accent-color: var(--accent);">
                        <span id="difficultyValue" style="font-weight: 700; color: var(--accent); width: 2ch; text-align: center;">5</span>
                    </div>
                    <div class="hint">How hard is it for AI to describe this GIF? (10 = nearly impossible)</div>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn btn-primary" id="saveBtn" onclick="saveChallenge()">Add Challenge</button>
                    <button class="btn btn-secondary" onclick="closeAddForm()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- PREVIEW TAB -->
        <div class="tab-pane" id="tab-preview">
            <div id="previewEmpty" class="empty-state">
                <div class="emoji">‚ñ∂Ô∏è</div>
                <p><strong>Nothing to preview</strong></p>
                <p>Add some challenges in the Build tab first</p>
                <button class="btn btn-secondary" onclick="switchTab('build')" style="margin-top: 1rem;">Go to Build</button>
            </div>

            <div id="previewActive" class="hidden">
                <!-- Intro -->
                <div id="previewIntro" style="text-align: center; padding: 2rem 1rem;">
                    <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Preview Your CAPTCHA Set</h2>
                    <p style="color: var(--muted); margin-bottom: 1rem;" id="previewIntroText">Test your challenges as a user would experience them</p>
                    <button class="btn btn-primary" onclick="startPreview()">Start Preview</button>
                </div>

                <!-- Challenge view -->
                <div id="previewChallenge" class="hidden">
                    <div class="preview-container">
                        <div class="preview-progress">
                            <div class="progress-track">
                                <div class="progress-fill" id="previewProgress" style="width: 0%"></div>
                            </div>
                            <div class="progress-info">
                                <span id="previewProgressText">Challenge 1 of 0</span>
                                <span id="previewScore">Answered: 0</span>
                            </div>
                        </div>
                        <div class="preview-header">
                            <span class="label">Challenge <strong id="previewNum">1</strong></span>
                            <span class="label" id="previewTitle"></span>
                        </div>
                        <div class="preview-gif" id="previewGif">
                            <span class="gif-loading">Loading GIF...</span>
                        </div>
                        <div class="preview-prompt">
                            <div class="prompt-text">üîç Describe the unexpected event in this GIF</div>
                            <div class="prompt-hint">What happens that you wouldn't expect? Be specific.</div>
                        </div>
                        <div class="preview-input" id="previewInputArea">
                            <textarea id="previewAnswer" placeholder="I see something unexpected happening..."></textarea>
                            <div class="preview-actions">
                                <span style="font-size: 0.75rem; color: var(--muted);"><span id="previewCharCount">0</span>/500</span>
                                <div class="btn-group">
                                    <button class="btn btn-secondary btn-small" onclick="previewSkip()">Skip</button>
                                    <button class="btn btn-primary btn-small" id="previewSubmitBtn" onclick="previewSubmit()" disabled>Submit</button>
                                </div>
                            </div>
                        </div>
                        <div class="preview-reveal hidden" id="previewReveal">
                            <div class="reveal-block user">
                                <div class="reveal-lbl">üë§ Your Answer</div>
                                <div class="reveal-txt" id="previewRevealUser"></div>
                            </div>
                            <div class="reveal-block expected">
                                <div class="reveal-lbl">‚úÖ Expected Answer</div>
                                <div class="reveal-txt" id="previewRevealExpected"></div>
                            </div>
                            <div style="text-align: center; margin-top: 0.8rem;">
                                <button class="btn btn-primary btn-small" id="previewNextBtn" onclick="previewNext()">Next ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results view -->
                <div id="previewResults" class="hidden">
                    <div class="results-summary">
                        <div class="big-score" id="previewBigScore"></div>
                        <div class="big-label">challenges answered</div>
                        <div id="previewResultsList" class="results-list"></div>
                        <div style="margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="startPreview()">Try Again</button>
                            <button class="btn btn-secondary" onclick="switchTab('build')" style="margin-left: 0.5rem;">Back to Build</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXPORT / IMPORT TAB -->
        <div class="tab-pane" id="tab-export">
            <h2 style="font-size: 1.2rem; margin-bottom: 1rem; color: var(--accent);">üì§ Export</h2>
            <p style="color: var(--muted); margin-bottom: 1rem; font-size: 0.9rem;">Export your CAPTCHA set as JSON to use in your own projects or share with others.</p>
            <div class="btn-group" style="margin-bottom: 1rem;">
                <button class="btn btn-primary btn-small" onclick="exportJSON()">Copy JSON</button>
                <button class="btn btn-secondary btn-small" onclick="downloadJSON()">Download .json</button>
                <button class="btn btn-secondary btn-small" onclick="generateShareLink()">üîó Share Link</button>
            </div>
            <div id="exportPreview" class="code-block" style="margin-bottom: 2rem;">
                // Your CAPTCHA set will appear here
            </div>

            <div id="shareSection" class="hidden" style="margin-bottom: 2rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--accent);">üîó Shareable Link</h3>
                <p style="color: var(--muted); font-size: 0.8rem; margin-bottom: 0.5rem;">Anyone with this link can import your CAPTCHA set (up to ~2KB compressed)</p>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="shareLink" readonly style="flex: 1; font-size: 0.8rem;">
                    <button class="btn btn-primary btn-small" onclick="copyShareLink()">Copy</button>
                </div>
            </div>

            <hr style="border: none; border-top: 1px solid var(--border); margin: 2rem 0;">

            <h2 style="font-size: 1.2rem; margin-bottom: 1rem; color: var(--accent);">üì• Import</h2>
            <p style="color: var(--muted); margin-bottom: 1rem; font-size: 0.9rem;">Import a CAPTCHA set from JSON. This will replace your current challenges.</p>
            <div class="form-group">
                <textarea id="importInput" placeholder='Paste JSON here (array of challenge objects)' style="min-height: 120px; font-family: monospace; font-size: 0.8rem;"></textarea>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary btn-small" onclick="importJSON()">Import JSON</button>
                <button class="btn btn-secondary btn-small" onclick="importFromFile()">Import from File</button>
            </div>
            <input type="file" id="fileInput" accept=".json" style="display: none;">

            <hr style="border: none; border-top: 1px solid var(--border); margin: 2rem 0;">

            <h2 style="font-size: 1.2rem; margin-bottom: 1rem; color: var(--accent);">üíæ Local Storage</h2>
            <p style="color: var(--muted); margin-bottom: 1rem; font-size: 0.9rem;">Your CAPTCHA set is auto-saved in your browser's local storage.</p>
            <div class="btn-group">
                <button class="btn btn-success btn-small" onclick="saveToStorage()">Save Now</button>
                <button class="btn btn-secondary btn-small" onclick="loadFromStorage()">Load Saved</button>
                <button class="btn btn-danger btn-small" onclick="clearStorage()">Clear Saved</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script src="shared.js"></script>
    <script>
        // ===== STATE =====
        var challenges = [];
        var editingIndex = -1; // -1 = adding new, >= 0 = editing existing
        var selectedCategory = "";

        // Preview state
        var pvIndex = 0;
        var pvAnswers = [];
        var pvAnswered = 0;
        var pvSkipped = 0;

        // sanitize() is now in shared.js

        // ===== TABS =====
        function switchTab(tabId) {
            document.querySelectorAll(".tab-btn").forEach(function(b) { b.classList.remove("active"); });
            document.querySelectorAll(".tab-pane").forEach(function(p) { p.classList.remove("active"); });
            document.querySelector('[data-tab="' + tabId + '"]').classList.add("active");
            document.getElementById("tab-" + tabId).classList.add("active");

            if (tabId === "preview") { updatePreviewTab(); }
            if (tabId === "export") { updateExportPreview(); }
        }

        // ===== TOAST =====
        function showToast(msg, type) {
            var toast = document.getElementById("toast");
            toast.textContent = msg;
            toast.className = "toast " + (type || "") + " visible";
            clearTimeout(toast._timer);
            toast._timer = setTimeout(function() {
                toast.classList.remove("visible");
            }, 2500);
        }

        // ===== BUILD TAB =====

        function updateStats() {
            document.getElementById("statCount").textContent = challenges.length;
            var cats = {};
            var totalDiff = 0;
            for (var i = 0; i < challenges.length; i++) {
                if (challenges[i].category) cats[challenges[i].category] = true;
                totalDiff += challenges[i].difficulty || 5;
            }
            document.getElementById("statCategories").textContent = Object.keys(cats).length;
            document.getElementById("statAvgDiff").textContent = challenges.length > 0
                ? (totalDiff / challenges.length).toFixed(1)
                : "‚Äî";

            document.getElementById("emptyState").classList.toggle("hidden", challenges.length > 0);
            autoSave();
        }

        function renderChallengeList() {
            var list = document.getElementById("challengeList");
            list.innerHTML = "";
            if (challenges.length === 0) {
                updateStats();
                return;
            }

            var frag = document.createDocumentFragment();
            for (var i = 0; i < challenges.length; i++) {
                frag.appendChild(createChallengeCard(i));
            }
            list.appendChild(frag);
            updateStats();
        }

        function createChallengeCard(idx) {
            var c = challenges[idx];
            var card = document.createElement("div");
            card.className = "challenge-card";
            card.dataset.index = idx;

            var catLabel = "";
            var categoryLabels = {
                narrative: "Narrative Twist", physical: "Physical Comedy",
                animal: "Animal Behavior", visual: "Visual Trick",
                social: "Social Subversion", illusion: "Optical Illusion"
            };
            if (c.category && categoryLabels[c.category]) {
                catLabel = '<span style="font-size:0.7rem; color:var(--muted); margin-left:0.4rem;">(' + categoryLabels[c.category] + ')</span>';
            }

            card.innerHTML =
                '<div class="card-row">' +
                    '<span class="card-num">' + (idx + 1) + '</span>' +
                    '<div class="card-preview" id="thumb-' + idx + '"></div>' +
                    '<div class="card-info">' +
                        '<div class="card-title">' + sanitize(c.title) + catLabel + '</div>' +
                        '<div class="card-url">' + sanitize(c.gifUrl) + '</div>' +
                    '</div>' +
                    '<div class="card-actions">' +
                        (idx > 0 ? '<button class="icon-btn up" title="Move up" onclick="moveChallenge(' + idx + ',-1)">‚Üë</button>' : '') +
                        (idx < challenges.length - 1 ? '<button class="icon-btn down" title="Move down" onclick="moveChallenge(' + idx + ',1)">‚Üì</button>' : '') +
                        '<button class="icon-btn" title="Edit" onclick="editChallenge(' + idx + ')">‚úé</button>' +
                        '<button class="icon-btn danger" title="Delete" onclick="deleteChallenge(' + idx + ')">‚úï</button>' +
                    '</div>' +
                '</div>';

            // Load thumbnail
            var thumbContainer = card.querySelector("#thumb-" + idx);
            var img = document.createElement("img");
            img.alt = c.title;
            img.src = c.gifUrl;
            img.onerror = function() { thumbContainer.style.display = "none"; };
            thumbContainer.appendChild(img);

            return card;
        }

        function openAddForm() {
            editingIndex = -1;
            document.getElementById("formTitle").textContent = "Add New Challenge";
            document.getElementById("saveBtn").textContent = "Add Challenge";
            document.getElementById("inputTitle").value = "";
            document.getElementById("inputGifUrl").value = "";
            document.getElementById("inputSourceUrl").value = "";
            document.getElementById("inputExpected").value = "";
            document.getElementById("inputDifficulty").value = 5;
            document.getElementById("difficultyValue").textContent = "5";
            selectedCategory = "";
            document.querySelectorAll(".category-chip").forEach(function(c) { c.classList.remove("selected"); });
            document.getElementById("addForm").classList.remove("hidden");
            document.getElementById("inputTitle").focus();
        }

        function closeAddForm() {
            document.getElementById("addForm").classList.add("hidden");
            editingIndex = -1;
        }

        function editChallenge(idx) {
            var c = challenges[idx];
            editingIndex = idx;
            document.getElementById("formTitle").textContent = "Edit Challenge #" + (idx + 1);
            document.getElementById("saveBtn").textContent = "Save Changes";
            document.getElementById("inputTitle").value = c.title;
            document.getElementById("inputGifUrl").value = c.gifUrl;
            document.getElementById("inputSourceUrl").value = c.sourceUrl || "";
            document.getElementById("inputExpected").value = c.expectedAnswer;
            document.getElementById("inputDifficulty").value = c.difficulty || 5;
            document.getElementById("difficultyValue").textContent = c.difficulty || 5;
            selectedCategory = c.category || "";
            document.querySelectorAll(".category-chip").forEach(function(chip) {
                chip.classList.toggle("selected", chip.dataset.cat === selectedCategory);
            });
            document.getElementById("addForm").classList.remove("hidden");
            document.getElementById("inputTitle").focus();
        }

        function saveChallenge() {
            var title = document.getElementById("inputTitle").value.trim();
            var gifUrl = document.getElementById("inputGifUrl").value.trim();
            var sourceUrl = document.getElementById("inputSourceUrl").value.trim();
            var expected = document.getElementById("inputExpected").value.trim();
            var difficulty = parseInt(document.getElementById("inputDifficulty").value);

            // Validation
            if (!title) { showToast("Title is required", "error"); return; }
            if (!gifUrl) { showToast("GIF URL is required", "error"); return; }
            if (!gifUrl.startsWith("https://")) { showToast("GIF URL must start with https://", "error"); return; }
            if (!expected) { showToast("Expected answer is required", "error"); return; }
            if (expected.length < 10) { showToast("Expected answer should be at least 10 characters", "error"); return; }

            var challenge = {
                title: title,
                gifUrl: gifUrl,
                sourceUrl: sourceUrl || gifUrl,
                expectedAnswer: expected,
                category: selectedCategory,
                difficulty: difficulty
            };

            if (editingIndex >= 0) {
                challenges[editingIndex] = challenge;
                showToast("Challenge updated ‚úì", "success");
            } else {
                challenges.push(challenge);
                showToast("Challenge added ‚úì", "success");
            }

            closeAddForm();
            renderChallengeList();
        }

        function deleteChallenge(idx) {
            challenges.splice(idx, 1);
            renderChallengeList();
            showToast("Challenge removed", "");
        }

        function moveChallenge(idx, dir) {
            var newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= challenges.length) return;
            var temp = challenges[idx];
            challenges[idx] = challenges[newIdx];
            challenges[newIdx] = temp;
            renderChallengeList();
        }

        function selectCategory(btn) {
            document.querySelectorAll(".category-chip").forEach(function(c) { c.classList.remove("selected"); });
            if (selectedCategory === btn.dataset.cat) {
                selectedCategory = "";
            } else {
                btn.classList.add("selected");
                selectedCategory = btn.dataset.cat;
            }
        }

        // Difficulty slider
        document.getElementById("inputDifficulty").addEventListener("input", function() {
            document.getElementById("difficultyValue").textContent = this.value;
        });

        function loadSampleSet() {
            challenges = [
                {
                    title: "Duel Plot Twist",
                    gifUrl: "https://media1.tenor.com/m/g50YYgVxFo4AAAAC/unexpected-plot-twist.gif",
                    sourceUrl: "https://tenor.com/view/unexpected-plot-twist-twist-plot-duel-gif-5053664",
                    expectedAnswer: "One person shot BANG and the other shot BOOM ‚Äî both had trick guns.",
                    category: "narrative",
                    difficulty: 9
                },
                {
                    title: "Rappers Roller Skating",
                    gifUrl: "https://i.gifer.com/G9lg.gif",
                    sourceUrl: "https://i.gifer.com/G9lg.gif",
                    expectedAnswer: "3 rappers rapping and then one roller skates away.",
                    category: "social",
                    difficulty: 8
                },
                {
                    title: "Flying Skateboarder",
                    gifUrl: "https://media.giphy.com/media/l0MYDnCqzU2MQj7OM/giphy.gif",
                    sourceUrl: "https://funnyordie.tumblr.com/post/102557790934",
                    expectedAnswer: "Skateboarder does a trick and flies up in the air.",
                    category: "physical",
                    difficulty: 5
                },
                {
                    title: "Road Rage Hug",
                    gifUrl: "https://media.giphy.com/media/brsEO1JayBVja/giphy.gif",
                    sourceUrl: "#",
                    expectedAnswer: "Road rage encounter unexpectedly ends with a friendly hug.",
                    category: "social",
                    difficulty: 9
                },
                {
                    title: "Birthday Cake Face Cover",
                    gifUrl: "https://media.giphy.com/media/xT0xeuOy2Fcl9vDGiA/giphy.gif",
                    sourceUrl: "#",
                    expectedAnswer: "Girl's face smashed into cake, but emerges clean ‚Äî had a paper plate cover.",
                    category: "narrative",
                    difficulty: 7
                }
            ];
            renderChallengeList();
            showToast("Loaded 5 sample challenges", "success");
        }

        // ===== PREVIEW TAB =====

        function updatePreviewTab() {
            if (challenges.length === 0) {
                document.getElementById("previewEmpty").classList.remove("hidden");
                document.getElementById("previewActive").classList.add("hidden");
            } else {
                document.getElementById("previewEmpty").classList.add("hidden");
                document.getElementById("previewActive").classList.remove("hidden");
                document.getElementById("previewIntro").classList.remove("hidden");
                document.getElementById("previewChallenge").classList.add("hidden");
                document.getElementById("previewResults").classList.add("hidden");
                document.getElementById("previewIntroText").textContent =
                    challenges.length + " challenge" + (challenges.length !== 1 ? "s" : "") + " ready to preview";
            }
        }

        function startPreview() {
            pvIndex = 0;
            pvAnswers = [];
            pvAnswered = 0;
            pvSkipped = 0;
            document.getElementById("previewIntro").classList.add("hidden");
            document.getElementById("previewResults").classList.add("hidden");
            document.getElementById("previewChallenge").classList.remove("hidden");
            loadPreviewChallenge(0);
        }

        function loadPreviewChallenge(idx) {
            pvIndex = idx;
            var c = challenges[idx];

            document.getElementById("previewNum").textContent = idx + 1;
            document.getElementById("previewTitle").textContent = c.title;
            document.getElementById("previewProgress").style.width = (idx / challenges.length * 100) + "%";
            document.getElementById("previewProgressText").textContent = "Challenge " + (idx + 1) + " of " + challenges.length;
            document.getElementById("previewScore").textContent = "Answered: " + pvAnswered;

            // Load GIF
            var container = document.getElementById("previewGif");
            container.innerHTML = '<span class="gif-loading">Loading GIF...</span>';
            var img = document.createElement("img");
            img.alt = c.title;
            img.onload = function() {
                container.innerHTML = "";
                container.appendChild(img);
            };
            img.onerror = function() {
                container.innerHTML = '<span class="gif-loading">‚ö†Ô∏è GIF failed to load. <a href="' + sanitize(c.gifUrl) + '" target="_blank" rel="noopener noreferrer" style="color:var(--accent);">Open in new tab ‚Üí</a></span>';
            };
            img.src = c.gifUrl;

            // Reset input
            document.getElementById("previewInputArea").classList.remove("hidden");
            document.getElementById("previewReveal").classList.add("hidden");
            var textarea = document.getElementById("previewAnswer");
            textarea.value = "";
            textarea.disabled = false;
            textarea.focus();
            document.getElementById("previewCharCount").textContent = "0";
            document.getElementById("previewSubmitBtn").disabled = true;
        }

        document.getElementById("previewAnswer").addEventListener("input", function() {
            document.getElementById("previewCharCount").textContent = this.value.length;
            document.getElementById("previewSubmitBtn").disabled = this.value.trim().length < 5;
        });

        document.getElementById("previewAnswer").addEventListener("keydown", function(e) {
            if (e.key === "Enter" && !e.shiftKey && this.value.trim().length >= 5) {
                e.preventDefault();
                previewSubmit();
            }
        });

        function previewSubmit() {
            var answer = document.getElementById("previewAnswer").value.trim();
            if (answer.length < 5) return;
            pvAnswered++;
            pvAnswers[pvIndex] = { text: answer, skipped: false };
            showPreviewReveal(answer);
        }

        function previewSkip() {
            pvSkipped++;
            pvAnswers[pvIndex] = { text: "(skipped)", skipped: true };
            showPreviewReveal("(skipped)");
        }

        function showPreviewReveal(userText) {
            document.getElementById("previewInputArea").classList.add("hidden");
            document.getElementById("previewRevealUser").textContent = userText;
            document.getElementById("previewRevealExpected").textContent = challenges[pvIndex].expectedAnswer;
            document.getElementById("previewNextBtn").textContent =
                pvIndex === challenges.length - 1 ? "See Results ‚Üí" : "Next ‚Üí";
            document.getElementById("previewReveal").classList.remove("hidden");
        }

        function previewNext() {
            if (pvIndex < challenges.length - 1) {
                loadPreviewChallenge(pvIndex + 1);
            } else {
                showPreviewResults();
            }
        }

        function showPreviewResults() {
            document.getElementById("previewChallenge").classList.add("hidden");
            document.getElementById("previewResults").classList.remove("hidden");
            document.getElementById("previewBigScore").textContent = pvAnswered + "/" + challenges.length;

            var list = document.getElementById("previewResultsList");
            var frag = document.createDocumentFragment();
            for (var i = 0; i < challenges.length; i++) {
                var row = document.createElement("div");
                row.className = "results-row";
                var ans = pvAnswers[i];
                var status = ans && !ans.skipped ? "‚úÖ" : "‚è≠Ô∏è";
                row.innerHTML =
                    '<span class="r-num">' + (i + 1) + '</span>' +
                    '<span class="r-title">' + sanitize(challenges[i].title) + '</span>' +
                    '<span class="r-status">' + status + '</span>';
                frag.appendChild(row);
            }
            list.innerHTML = "";
            list.appendChild(frag);
        }

        // ===== EXPORT / IMPORT =====

        function getExportData() {
            return challenges.map(function(c, i) {
                return {
                    id: i + 1,
                    title: c.title,
                    gifUrl: c.gifUrl,
                    sourceUrl: c.sourceUrl || c.gifUrl,
                    expectedAnswer: c.expectedAnswer,
                    category: c.category || "uncategorized",
                    difficulty: c.difficulty || 5
                };
            });
        }

        function updateExportPreview() {
            var data = getExportData();
            var json = JSON.stringify(data, null, 2);
            document.getElementById("exportPreview").textContent = json;
        }

        function exportJSON() {
            var data = getExportData();
            var json = JSON.stringify(data, null, 2);
            try {
                navigator.clipboard.writeText(json);
                showToast("JSON copied to clipboard ‚úì", "success");
            } catch (e) {
                // Fallback
                document.getElementById("exportPreview").textContent = json;
                showToast("Copy from the preview below", "");
            }
        }

        function downloadJSON() {
            var data = getExportData();
            var json = JSON.stringify(data, null, 2);
            var blob = new Blob([json], { type: "application/json" });
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            a.download = "gif-captcha-set.json";
            a.click();
            URL.revokeObjectURL(url);
            showToast("Downloaded gif-captcha-set.json ‚úì", "success");
        }

        function generateShareLink() {
            if (challenges.length === 0) {
                showToast("No challenges to share", "error");
                return;
            }
            var data = getExportData();
            var json = JSON.stringify(data);

            // Use base64 encoding for URL safety
            try {
                var encoded = btoa(unescape(encodeURIComponent(json)));
                if (encoded.length > 4000) {
                    showToast("Set too large for URL sharing (>" + Math.round(encoded.length / 1024) + "KB). Use JSON export instead.", "error");
                    return;
                }
                var link = window.location.href.split("#")[0].split("?")[0] + "?data=" + encodeURIComponent(encoded);
                document.getElementById("shareLink").value = link;
                document.getElementById("shareSection").classList.remove("hidden");
                showToast("Share link generated ‚úì", "success");
            } catch (e) {
                showToast("Failed to generate share link", "error");
            }
        }

        function copyShareLink() {
            var input = document.getElementById("shareLink");
            try {
                navigator.clipboard.writeText(input.value);
                showToast("Link copied ‚úì", "success");
            } catch (e) {
                input.select();
                showToast("Select and copy manually", "");
            }
        }

        function importJSON() {
            var input = document.getElementById("importInput").value.trim();
            if (!input) { showToast("Paste JSON first", "error"); return; }
            try {
                var data = JSON.parse(input);
                if (!Array.isArray(data)) { showToast("JSON must be an array of challenges", "error"); return; }
                if (data.length === 0) { showToast("No challenges found in JSON", "error"); return; }

                challenges = data.map(function(c) {
                    return {
                        title: c.title || "Untitled",
                        gifUrl: c.gifUrl || "",
                        sourceUrl: c.sourceUrl || c.gifUrl || "",
                        expectedAnswer: c.expectedAnswer || c.humanAnswer || "",
                        category: c.category || "",
                        difficulty: c.difficulty || 5
                    };
                });

                renderChallengeList();
                switchTab("build");
                showToast("Imported " + challenges.length + " challenges ‚úì", "success");
            } catch (e) {
                showToast("Invalid JSON: " + e.message, "error");
            }
        }

        function importFromFile() {
            document.getElementById("fileInput").click();
        }

        document.getElementById("fileInput").addEventListener("change", function(e) {
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(ev) {
                document.getElementById("importInput").value = ev.target.result;
                importJSON();
            };
            reader.readAsText(file);
            e.target.value = "";
        });

        // ===== LOCAL STORAGE =====
        var STORAGE_KEY = "gif-captcha-workshop";

        function autoSave() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(challenges));
            } catch (e) { /* ignore */ }
        }

        function saveToStorage() {
            autoSave();
            showToast("Saved to browser storage ‚úì", "success");
        }

        function loadFromStorage() {
            try {
                var saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) { showToast("No saved data found", "error"); return; }
                challenges = JSON.parse(saved);
                renderChallengeList();
                showToast("Loaded " + challenges.length + " challenges from storage ‚úì", "success");
            } catch (e) {
                showToast("Failed to load: " + e.message, "error");
            }
        }

        function clearStorage() {
            try {
                localStorage.removeItem(STORAGE_KEY);
                showToast("Saved data cleared", "");
            } catch (e) { /* ignore */ }
        }

        // ===== URL IMPORT =====
        function checkUrlImport() {
            var params = new URLSearchParams(window.location.search);
            var data = params.get("data");
            if (data) {
                try {
                    var json = decodeURIComponent(escape(atob(decodeURIComponent(data))));
                    var parsed = JSON.parse(json);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        challenges = parsed.map(function(c) {
                            return {
                                title: c.title || "Untitled",
                                gifUrl: c.gifUrl || "",
                                sourceUrl: c.sourceUrl || c.gifUrl || "",
                                expectedAnswer: c.expectedAnswer || c.humanAnswer || "",
                                category: c.category || "",
                                difficulty: c.difficulty || 5
                            };
                        });
                        renderChallengeList();
                        showToast("Imported " + challenges.length + " challenges from link ‚úì", "success");
                        // Clean URL
                        history.replaceState(null, "", window.location.pathname);
                    }
                } catch (e) {
                    // Silently fail for bad URL data
                }
            }
        }

        // ===== INIT =====
        function init() {
            // Check URL import first
            checkUrlImport();

            // If no URL import, try localStorage
            if (challenges.length === 0) {
                try {
                    var saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        challenges = JSON.parse(saved);
                    }
                } catch (e) { /* ignore */ }
            }

            renderChallengeList();
        }

        init();
    </script>
</body>
</html>
